# â˜ï¸ Cloud Networking Special Topic  
## Overlay vs Underlay Debugging in Cloud Fabrics  
*(How to debug â€œnetwork issuesâ€ when nothing is actually simple)*  

**Written By: Vinod N. Rathod**

---

## ğŸ§  Overlay vs Underlay â€” First Principles

**Definition:**  

- **Underlay Network**  
  The physical or base IP network that moves packets between hosts.
  - Physical switches
  - Routers
  - IP routing (BGP/OSPF)
  - Provider backbone

- **Overlay Network**  
  A virtual network built **on top of the underlay**.
  - VXLAN / GRE tunnels
  - VPCs / VNets
  - Pod networks
  - Tenant isolation

The underlay doesnâ€™t know tenants exist.  
The overlay doesnâ€™t care how packets move physically.

This separation is powerful â€” and brutal to debug.

---

## ğŸ¯ Why This Topic Matters

Classic cloud incident:

- VM canâ€™t reach another VM  
- Routes look correct  
- Security groups look correct  
- DNS resolves fine  
- **Yet packets disappear**

Reason:
Overlay and underlay are **independent failure
 domains**.


Most engineers debug only the overlay.  
The problem often lives in the underlay.

---

## ğŸ§± Mental Model (Critical)

Application â†“ Overlay Network (VXLAN, VPC, Pod CIDRs) â†“ Encapsulation â†“ Underlay Network (IP routing, backbone) â†“ Decapsulation â†“ Overlay Network


If **any layer breaks**, traffic fails.

---

## ğŸŒ Underlay Responsibilities

The underlay is responsible for:

- IP reachability between hosts
- MTU consistency
- Packet loss and congestion
- ECMP and routing convergence
- Physical link health

If underlay fails:
- Overlays fail silently
- No obvious config errors appear

---

## ğŸŒ Overlay Responsibilities

The overlay handles:

- Tenant isolation
- Virtual IP addressing
- Routing inside VPCs / clusters
- Security enforcement
- Encapsulation / decapsulation

If overlay fails:
- Only specific tenants or services break
- Other traffic may work fine

---

## ğŸ” Common Failure Scenarios

### 1ï¸âƒ£ MTU Mismatch (Most Common)

Overlay adds encapsulation headers.

Example:
- Underlay MTU = 1500
- VXLAN adds ~50 bytes
- Packet gets fragmented or dropped

Symptoms:
- Small pings work
- Large requests fail
- TLS handshakes hang
- gRPC randomly breaks

Fix:
- Lower overlay MTU
- Or increase underlay MTU

---

### 2ï¸âƒ£ Underlay Packet Loss

Overlay assumes:
> â€œUnderlay is reliableâ€

Reality:
- Congested links
- Bad ECMP hashing
- Failing NICs
- Asymmetric paths

Symptoms:
- Random timeouts
- Retries hide the issue
- Only high-throughput apps fail

Overlay retries mask underlay pain.

---

### 3ï¸âƒ£ Overlay Control Plane Healthy, Data Plane Broken

- Routes exist
- Tunnel endpoints known
- Policies applied

But:
- Encapsulation not happening
- Decapsulation failing
- Host agent stuck

Symptoms:
- Control plane looks green
- Traffic blackholes

This is why cloud outages are confusing.

---

### 4ï¸âƒ£ Asymmetric Routing Between Layers

Overlay expects symmetric paths.

Underlay may route:
- Forward path one way
- Return path another way

Symptoms:
- SYN sent, SYN-ACK lost
- One-way traffic
- Load balancer health checks fail

Very hard to see without packet capture.

---

## ğŸ” How to Debug Systematically

### Step 1: Prove Overlay Failure

- Same subnet traffic?
- Cross-AZ traffic?
- Cross-VPC traffic?

Identify **scope** of failure.

---

### Step 2: Reduce to Underlay Signals

Ask:
- Is packet loss present?
- Is latency spiking?
- Is MTU consistent?
- Are paths symmetric?

Even if you canâ€™t see the physical network, symptoms leak upward.

---

### Step 3: Strip Encapsulation (Mentally)

Think in raw IP terms:
- Source host â†’ Destination host
- Ignore VPC, ignore pod IPs

If hosts canâ€™t reach:
Overlay never stood a chance.

---

## ğŸ” Security Side Effects

Overlay security may appear broken when underlay fails.

Example:
- Security group allows traffic
- But packets never arrive

Result:
- False security alarms
- Engineers chase policies instead of physics

Physics always wins.

---

## ğŸ—ï¸ Why Clouds Separate Overlay & Underlay

Because it allows:

- Massive scale
- Tenant isolation
- Independent evolution
- Hardware abstraction

Cost:
- Debugging complexity
- Visibility loss
- Steep learning curve

Cloud trades simplicity for scale.

---

## ğŸ—ï¸ Real-World Cloud Examples

**AWS:**
- Overlay â†’ VPC, ENI, VXLAN-like fabric
- Underlay â†’ Global backbone + Nitro hosts

**Azure:**
- Overlay â†’ SDN + VFP
- Underlay â†’ Provider IP fabric

**GCP:**
- Overlay â†’ Andromeda
- Underlay â†’ Jupiter fabric

In all cases:
Customers see overlays.  
Failures often originate underneath.

---

## ğŸ§¾ Quick Recap

| Layer | Handles | Typical Failures |
|----|-------|----------------|
| Overlay | Isolation, routing, security | Blackholes, policy confusion |
| Underlay | Packet movement | Loss, MTU, congestion |
| MTU | Both | Silent drops |
| Control Plane | Decisions | Stale state |
| Data Plane | Reality | Traffic loss |

---

## âš¡ In Simple Terms

Overlay says:
â€œI want to send traffic.â€

Underlay says:
â€œIâ€™ll try.â€

If underlay lies,  
overlay canâ€™t save you.

Most cloud networking bugs are not misconfigurations.  
They are **physics leaking through abstraction**.

---

**~ V1NNN22 ~**  
**THANK YOU!**
