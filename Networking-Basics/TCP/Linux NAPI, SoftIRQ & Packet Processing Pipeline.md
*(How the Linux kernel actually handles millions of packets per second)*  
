# â˜ï¸ Cloud Networking Special Topic  
## Linux NAPI, SoftIRQ & Packet Processing Pipeline  
*(How the Linux kernel actually handles millions of packets per second)*  

**Written By: Vinod N. Rathod**

---

## ğŸ§  Why Kernel Packet Processing Matters

When packets reach a server, the network is not done.

The kernel must:
- Receive packets
- Process headers
- Apply firewall rules
- Route traffic
- Deliver to applications

At high scale:
- Millions of packets/sec
- Thousands of flows
- Multiple CPUs

If kernel packet handling is inefficient:
> The server becomes the bottleneck, not the network.

---

## ğŸ¯ The Core Problem

Naive packet handling design:

Packet arrives â†’ interrupt CPU â†’ process packet

At high packet rates:

- Interrupt storm occurs
- CPU spends all time context switching
- Throughput collapses

Kernel must handle packets efficiently without overwhelming CPU.

---

## ğŸ§± The Linux Packet Processing Pipeline

Real receive path:

NIC â†“ DMA â†’ RX Ring â†“ Interrupt â†“ SoftIRQ â†“ NAPI Poll â†“ Protocol Stack â†“ Socket Buffer â†“ Application

Each step has performance implications.

---

## ğŸ§  What is SoftIRQ?

**SoftIRQ (Software Interrupt)** is a lightweight kernel mechanism used for **high-frequency tasks like packet processing**.

Difference:

| Type | Purpose |
|-----|--------|
| Hardware Interrupt | Urgent signal from device |
| SoftIRQ | Deferred processing |

NIC interrupt only signals:
> â€œPackets arrivedâ€

Actual work is done later in SoftIRQ context.

This prevents interrupt storms.

---

## ğŸ§± Interrupt vs SoftIRQ Separation

Old model:
Interrupt handled everything.

Modern model:
Interrupt just wakes kernel.

Then:
SoftIRQ handles packet processing.

Benefits:
- Lower latency
- Higher throughput
- Better CPU scheduling

---

## ğŸŒ What is NAPI?

**NAPI (New API)** is Linuxâ€™s hybrid interrupt + polling system for packet processing.

Instead of processing packets immediately:

1. NIC triggers interrupt
2. Kernel disables further interrupts
3. Kernel polls NIC for packets
4. Processes packets in batches
5. Re-enables interrupts

This avoids interrupt overload.

---

## ğŸ” Interrupt Mode vs Poll Mode

---

### Interrupt Mode (Low Traffic)

Few packets â†’ interrupts enabled.

Advantages:
- Low latency
- Immediate response

---

### Poll Mode (High Traffic)

Heavy traffic â†’ kernel polls NIC.

Advantages:
- Efficient batching
- Fewer interrupts
- Higher throughput

---

### Hybrid (NAPI)

Linux dynamically switches modes:

| Traffic | Mode |
|-------|------|
| Low | Interrupt |
| High | Polling |

This adaptive behavior is why Linux scales.

---

## ğŸ’¥ Why Packet Batching Matters

Processing packets one by one is expensive.

Batch processing allows:

- Fewer memory accesses
- Fewer locks
- Better cache usage
- Lower overhead

Batching improves:
- Throughput
- CPU efficiency
- Latency stability

Modern networking depends heavily on batching.

---

## ğŸ§± Receive Side Scaling (RSS)

Modern NICs distribute packets across CPU cores.

Mechanism:
- Hash packet headers
- Assign flow to CPU queue

Result:

CPU1 â†’ Flow A CPU2 â†’ Flow B CPU3 â†’ Flow C

Benefits:
- Parallel processing
- Higher throughput
- Better cache locality

Without RSS:
One CPU would bottleneck.

---

## ğŸ” Why Kernel Networking Can Become Bottleneck

Common causes:

- SoftIRQ saturation
- RX queue imbalance
- CPU affinity misconfiguration
- Too many small packets
- Interrupt imbalance

Symptoms:

- High softirq CPU usage
- Packet drops
- Latency spikes
- Uneven CPU load

Network looks slow.  
Problem is kernel scheduling.

---

## ğŸ§  What Happens During Packet Flood

Under heavy load:

1. NIC receives packets
2. Kernel switches to polling
3. CPU handles batches
4. SoftIRQ load increases
5. Kernel prioritizes network processing
6. Application gets less CPU time

Extreme case:
Server spends all CPU handling packets.

Apps starve.

---

## ğŸ—ï¸ Hyperscaler Kernel Optimizations

Cloud providers modify kernel networking with:

- Custom NAPI tuning
- Adaptive interrupt thresholds
- Queue balancing
- NUMA-aware scheduling
- XDP fast paths
- eBPF offloading

They optimize kernel network path as aggressively as hardware.

---

## ğŸ§¾ Quick Recap

| Component | Role |
|--------|------|
| NIC | Receives packets |
| Interrupt | Signals packet arrival |
| SoftIRQ | Deferred processing |
| NAPI | Hybrid interrupt/poll |
| RSS | Multi-core distribution |
| Goal | High throughput + low overhead |

---

## âš¡ In Simple Terms

Packets donâ€™t go straight to your app.

They must pass through a kernel assembly line.

If that assembly line slows down:
- Packets wait
- Latency spikes
- Throughput drops

Modern networking performance is often limited not by bandwidthâ€¦

â€¦but by how efficiently the kernel handles packets.

---

**~ V1NNN22 ~**  
**THANK YOU!**
